<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro - Zaq</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/pt-br.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg-primary: #0F172A; --bg-secondary: #1E293B; --bg-card: #2A3648; --bg-card-glass: rgba(42, 54, 72, 0.6); --text-primary: #F8FAFC; --text-secondary: #CBD5E1; --text-muted: #94A3B8; --accent-teal: #14B8A6; --accent-blue: #3B82F6; --accent-purple: #8B5CF6; --accent-orange: #F59E0B; --accent-red: #EF4444; --accent-green: #10B981; --border-color: #475569; --border-color-light: #64748B; --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05); --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); --shadow-md: 0 6px 10px -2px rgba(0, 0, 0, 0.15), 0 3px 6px -2px rgba(0, 0, 0, 0.1); --shadow-lg: 0 10px 20px -5px rgba(0, 0, 0, 0.25), 0 5px 10px -5px rgba(0, 0, 0, 0.15); --border-radius: 16px; --border-radius-sm: 8px; --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); --sidebar-width: 250px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, var(--bg-primary) 0%, #171d28 50%, #0c1017 100%); color: var(--text-primary); line-height: 1.6; min-height: 100vh; display: flex; overflow-x: hidden; }
        .app-wrapper { display: flex; width: 100%; min-height: 100vh; position: relative; }
        .sidebar { width: var(--sidebar-width); background: var(--bg-secondary); color: var(--text-primary); padding: 24px; position: fixed; height: 100vh; overflow-y: auto; box-shadow: var(--shadow-lg); z-index: 1000; background-color: var(--bg-card-glass); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); transition: transform 0.3s ease-in-out; transform: translateX(-100%); left: 0; }
        .sidebar.open { transform: translateX(0); }
        .sidebar-header { text-align: center; margin-bottom: 32px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color-light); }
        .sidebar-header h2 { font-size: 1.8rem; font-weight: 800; background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 8px; letter-spacing: -0.5px; }
        .sidebar-nav ul { list-style: none; padding: 0; }
        .sidebar-nav li { margin-bottom: 8px; }
        .sidebar-nav a { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: var(--text-secondary); text-decoration: none; border-radius: var(--border-radius-sm); transition: var(--transition); font-weight: 500; font-size: 1rem; position: relative; overflow: hidden; cursor: pointer; }
        .sidebar-nav a::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, rgba(20, 184, 166, 0.05), rgba(59, 130, 246, 0.05)); transition: left 0.3s ease-out; z-index: 0; }
        .sidebar-nav a:hover::before { left: 0; }
        .sidebar-nav a:hover { color: var(--accent-teal); transform: translateX(5px); }
        .sidebar-nav a.active { background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple)); color: white; box-shadow: var(--shadow-md); transform: translateX(0); font-weight: 600; }
        .sidebar-nav a i, .sidebar-nav a span { z-index: 1; }
        .main-content-area { flex-grow: 1; width: 100%; transition: margin-left 0.3s ease-in-out; }
        .container { max-width: 1400px; margin: 0 auto; padding: 16px; }
        @media (min-width: 768px) { .container { padding: 24px; } }
        .header { display: flex; flex-direction: column; gap: 16px; text-align: center; margin-bottom: 32px; padding: 20px; background: rgba(30, 41, 59, 0.4); border-radius: var(--border-radius); margin-top: 10px; box-shadow: var(--shadow-md); }
        @media (min-width: 768px) { .header { flex-direction: row; justify-content: space-between; align-items: center; text-align: left; padding: 20px 30px; } }
        .header-left { width: 100%; margin-bottom: 16px; }
        @media (min-width: 768px) { .header-left { width: auto; margin-bottom: 0; } }
        .header-left h1 { font-size: 1.8rem; font-weight: 800; background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 8px; letter-spacing: -1px; }
        @media (min-width: 768px) { .header-left h1 { font-size: 2.5rem; } }
        .header-left p { color: var(--text-secondary); font-size: 1rem; font-weight: 500; }
        @media (min-width: 768px) { .header-left p { font-size: 1.1rem; } }
        .header-right { display: flex; flex-direction: column; gap: 16px; align-items: center; width: 100%; }
        @media (min-width: 768px) { .header-right { flex-direction: row; justify-content: flex-end; width: auto; } }
        .filter-controls { display: flex; flex-direction: column; gap: 10px; align-items: center; width: 100%; }
        @media (min-width: 768px) { .filter-controls { flex-direction: row; width: auto; } }
        .filter-controls select, .filter-controls input[type="number"], .refresh-btn { width: 100%; padding: 10px 15px; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color-light); background-color: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23CBD5E1%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.2-6.4H18.4c-5%200-9.3%201.8-13.2%206.4-3.9%204.6-5.8%2010.2-5.8%2016.1s1.9%2011.5%205.8%2016.1l128%20127.9c3.9%203.9%208.7%205.8%2013.2%205.8s9.3-1.9%2013.2-5.8L287%20101.5c3.9-4.7%205.8-10.2%205.8-16.1S290.9%2074.1%20287%2069.4z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 10px top 50%; background-size: 12px auto; cursor: pointer; }
        @media (min-width: 768px) { .filter-controls select, .filter-controls input[type="number"], .refresh-btn { width: auto; } }
        .filter-controls input[type="number"]::-webkit-inner-spin-button, .filter-controls input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .filter-controls input[type="number"] { -moz-appearance: textfield; }
        .last-update { color: var(--text-muted); font-size: 0.9rem; text-align: right; width: 100%; }
        @media (min-width: 768px) { .last-update { width: auto; } }
        .loading { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 60vh; color: var(--text-secondary); }
        .loading i { font-size: 3rem; margin-bottom: 16px; animation: spin 1s linear infinite; color: var(--accent-teal); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .summary-grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
        @media (min-width: 640px) { .summary-grid { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; } }
        .summary-card { background: var(--bg-card); border-radius: var(--border-radius); padding: 20px; border: 1px solid var(--border-color); transition: var(--transition); position: relative; overflow: hidden; box-shadow: var(--shadow-md); }
        @media (min-width: 768px) { .summary-card { padding: 24px; } }
        .summary-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, var(--accent-teal), var(--accent-blue)); box-shadow: 0 0 15px rgba(20, 184, 166, 0.5); transition: var(--transition); border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); }
        .summary-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); border-color: var(--accent-teal); }
        .summary-card.receitas::before { background: linear-gradient(90deg, var(--accent-green), var(--accent-teal)); box-shadow: 0 0 15px rgba(16, 185, 129, 0.5); }
        .summary-card.despesas::before { background: linear-gradient(90deg, var(--accent-red), var(--accent-orange)); box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); }
        .summary-card.saldo::before { background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple)); box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        .summary-card.saldo:hover { box-shadow: 0 0 25px rgba(59, 130, 246, 0.7), var(--shadow-lg); border-color: var(--accent-blue); }
        .summary-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .summary-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; box-shadow: var(--shadow-sm); }
        .summary-icon.receitas { background: linear-gradient(135deg, var(--accent-green), var(--accent-teal)); }
        .summary-icon.despesas { background: linear-gradient(135deg, var(--accent-red), var(--accent-orange)); }
        .summary-icon.saldo { background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); }
        .summary-trend { font-size: 0.9rem; padding: 4px 8px; border-radius: 20px; font-weight: 600; display: flex; align-items: center; gap: 4px; }
        .trend-up { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .trend-down { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .summary-value { font-size: 1.75rem; font-weight: 800; margin-bottom: 8px; background: linear-gradient(45deg, var(--text-primary), var(--text-secondary), var(--text-primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; animation: text-gradient-shift 5s ease-in-out infinite alternate; }
        @media (min-width: 768px) { .summary-value { font-size: 2.25rem; } }
        @keyframes text-gradient-shift { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        .summary-label { color: var(--text-muted); font-size: 0.9rem; font-weight: 500; }
        @media (min-width: 768px) { .summary-label { font-size: 1rem; } }
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 24px; align-items: start; }
        @media (min-width: 1024px) { .main-grid { grid-template-columns: 1fr 1fr; gap: 32px; } }
        .left-column, .right-column { display: flex; flex-direction: column; gap: 24px; }
        @media (min-width: 1024px) { .left-column, .right-column { gap: 32px; } }
        .card { background: var(--bg-card); border-radius: var(--border-radius); border: 1px solid var(--border-color); transition: var(--transition); overflow: hidden; flex-grow: 1; box-shadow: var(--shadow-md); }
        .card:hover { border-color: var(--accent-teal); box-shadow: var(--shadow-lg); transform: translateY(-3px); }
        .card-header { padding: 20px 20px 0 20px; display: flex; align-items: center; margin-bottom: 16px; position: relative; z-index: 1; }
        @media (min-width: 768px) { .card-header { padding: 24px 24px 0 24px; margin-bottom: 20px; } }
        .card-icon { width: 36px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 1.1rem; color: white; box-shadow: var(--shadow-sm); }
        @media (min-width: 768px) { .card-icon { width: 40px; font-size: 1.2rem; margin-right: 16px; } }
        .card-title { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); letter-spacing: -0.2px; }
        @media (min-width: 768px) { .card-title { font-size: 1.25rem; } }
        .card-content { padding: 0 20px 20px 20px; position: relative; overflow-y: auto; max-height: 400px; }
        @media (min-width: 768px) { .card-content { padding: 0 24px 24px 24px; } }
        .account-name { font-weight: 600; color: var(--text-primary); margin-bottom: 2px; }
        .account-type { font-size: 0.85rem; color: var(--text-muted); }
        .account-balance { font-weight: 700; font-size: 1.1rem; }
        .positive { color: var(--accent-green); }
        .negative { color: var(--accent-red); }
        .neutral { color: var(--accent-blue); }
        .credit-card { background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary)); border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid var(--border-color-light); transition: var(--transition); box-shadow: var(--shadow-sm); }
        .credit-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .credit-card:last-child { margin-bottom: 0; }
        .card-header-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .card-name { font-weight: 700; color: var(--text-primary); font-size: 1.1rem; }
        .card-limit { font-size: 0.9rem; color: var(--text-muted); }
        .usage-bar { width: 100%; height: 8px; background: var(--bg-primary); border-radius: 4px; overflow: hidden; margin: 12px 0; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); }
        .usage-fill { height: 100%; background: linear-gradient(90deg, var(--accent-teal), var(--accent-blue)); border-radius: 44px; transition: width 0.5s ease; }
        .usage-fill.high { background: linear-gradient(90deg, var(--accent-orange), var(--accent-red)); }
        .usage-info { display: flex; justify-content: space-between; font-size: 0.9rem; }
        .usage-percentage { color: var(--text-secondary); }
        .usage-amount { color: var(--text-primary); font-weight: 600; }
        .transaction-item { display: flex; align-items: center; padding: 16px 0; border-bottom: 1px solid rgba(var(--border-color-light), 0.5); transition: var(--transition); position: relative; }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-item:hover { background: rgba(20, 184, 166, 0.08); margin: 0 -24px; padding: 16px 24px; border-radius: var(--border-radius-sm); }
        .transaction-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 16px; font-size: 1.1rem; color: white; box-shadow: var(--shadow-sm); }
        .transaction-icon.receita { background: linear-gradient(135deg, var(--accent-green), var(--accent-teal)); }
        .transaction-icon.despesa { background: linear-gradient(135deg, var(--accent-red), var(--accent-orange)); }
        .transaction-details { flex: 1; min-width: 0; }
        .transaction-desc { font-weight: 600; color: var(--text-primary); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .transaction-meta { font-size: 0.85rem; color: var(--text-muted); }
        .transaction-amount { font-weight: 700; font-size: 1rem; text-align: right; white-space: nowrap; }
        @media (min-width: 768px) { .transaction-amount { font-size: 1.1rem; } }
        .transaction-actions { display: flex; gap: 8px; margin-left: 16px; opacity: 0; transition: opacity 0.3s ease; }
        .transaction-item:hover .transaction-actions { opacity: 1; }
        .transaction-actions button { background: none; border: none; color: var(--text-secondary); font-size: 1rem; cursor: pointer; padding: 5px; border-radius: 5px; transition: background-color 0.2s ease, color 0.2s ease; }
        .transaction-actions button:hover { background-color: rgba(255, 255, 255, 0.1); color: var(--accent-blue); }
        .transaction-actions button.delete-btn:hover { color: var(--accent-red); }
        @keyframes highlight-fade { 0% { background-color: rgba(20, 184, 166, 0.2); } 100% { background-color: transparent; } }
        .highlight { animation: highlight-fade 2s ease-in-out; }
        .bill-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid rgba(var(--border-color-light), 0.5); transition: var(--transition); }
        .bill-item:last-child { border-bottom: none; }
        .bill-item:hover { background: rgba(20, 184, 166, 0.08); margin: 0 -24px; padding: 16px 24px; border-radius: var(--border-radius-sm); }
        .bill-info { flex: 1; }
        .bill-desc { font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .bill-due { font-size: 0.85rem; color: var(--text-muted); }
        .bill-amount { font-weight: 700; font-size: 1.1rem; margin-bottom: 4px; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
        .status-pendente { background: rgba(245, 158, 11, 0.2); color: var(--accent-orange); }
        .status-pago { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .status-vencido { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .progress-item { margin-bottom: 20px; }
        .progress-item:last-child { margin-bottom: 0; }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .progress-label { font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
        .progress-percentage { font-size: 0.9rem; color: var(--text-secondary); font-weight: 600; }
        .progress-bar { width: 100%; height: 8px; background: var(--bg-primary); border-radius: 4px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent-teal), var(--accent-blue)); border-radius: 4px; transition: width 0.5s ease; }
        .progress-fill.over-budget { background: linear-gradient(90deg, var(--accent-orange), var(--accent-red)); }
        .progress-values { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-muted); }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state i { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }
        .card-content .empty-state { min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .error-message { background: rgba(239, 68, 68, 0.1); color: var(--accent-red); padding: 16px; border-radius: var(--border-radius-sm); margin: 20px 0; border-left: 4px solid var(--accent-red); box-shadow: var(--shadow-sm); }
        .chart-container { position: relative; height: auto; min-height: 300px; width: 100%; margin: auto; }
        #expenses-chart { cursor: pointer; }
        @media (min-width: 768px) { .chart-container { min-height: 350px; } }
        .fab { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: var(--shadow-lg); cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; z-index: 1001; }
        @media (min-width: 768px) { .fab { bottom: 30px; right: 30px; width: 60px; height: 60px; font-size: 1.8rem; } }
        .fab:hover { transform: scale(1.05) translateY(-5px); box-shadow: 0 15px 25px rgba(20, 184, 166, 0.4); }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: var(--bg-card); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); width: 95%; max-width: 600px; position: relative; transform: translateY(-50px); opacity: 0; animation: modal-fade-in 0.3s forwards ease-out; border: 1px solid var(--border-color-light); max-height: 90vh; overflow-y: auto; }
        .modal-body { padding-top: 20px; }
        #category-transactions-list .transaction-item { padding: 12px 0; }
        #category-transactions-list .transaction-item:hover { background: none; margin: 0; padding: 12px 0; border-radius: 0; }
        @media (min-width: 768px) { .modal-content { padding: 30px; } }
        @keyframes modal-fade-in { to { transform: translateY(0); opacity: 1; } }
        .close-button { color: var(--text-muted); font-size: 1.8rem; font-weight: bold; position: absolute; top: 10px; right: 15px; cursor: pointer; transition: color 0.3s ease; }
        @media (min-width: 768px) { .close-button { font-size: 2rem; top: 15px; right: 25px; } }
        .close-button:hover, .close-button:focus { color: var(--accent-red); text-decoration: none; cursor: pointer; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .modal-header h3 { font-size: 1.5rem; color: var(--text-primary); font-weight: 700; background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        @media (min-width: 768px) { .modal-header h3 { font-size: 1.8rem; } }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 600; font-size: 0.95rem; }
        .form-group input[type="date"], .form-group input[type="text"], .form-group input[type="number"], .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color-light); background-color: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; transition: border-color 0.3s ease, box-shadow 0.3s ease; border-radius: var(--border-radius-sm); }
        .form-group input[type="date"]:focus, .form-group input[type="text"]:focus, .form-group input[type="number"]:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px; }
        .btn { padding: 12px 25px; border-radius: var(--border-radius-sm); border: none; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease; box-shadow: var(--shadow-sm); }
        .btn-primary { background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue)); color: white; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn-secondary { background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color-light); }
        .btn-secondary:hover { background-color: var(--bg-card); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        #feedback-message { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: var(--border-radius-sm); font-weight: 600; color: var(--text-primary); box-shadow: var(--shadow-md); z-index: 3000; opacity: 0; transform: translateY(-20px); transition: opacity 0.3s ease-out, transform 0.3s ease-out; display: flex; align-items: center; gap: 10px; }
        #feedback-message.success { background-color: var(--accent-green); }
        #feedback-message.error { background-color: var(--accent-red); }
        #feedback-message.show { opacity: 1; transform: translateY(0); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999; display: none; }
        .overlay.show { display: block; }
        .hamburger-menu { display: block; font-size: 1.5rem; color: var(--text-primary); cursor: pointer; z-index: 1002; position: fixed; top: 15px; left: 15px; background-color: var(--bg-secondary); width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: var(--border-radius-sm); box-shadow: var(--shadow-md); }
        #confirmDeleteModal .modal-content { max-width: 400px; text-align: center; }
        #confirmDeleteModal .modal-header { justify-content: center; border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        #confirmDeleteModal .modal-header h3 { font-size: 1.6rem; color: var(--accent-red); background: none; -webkit-text-fill-color: var(--accent-red); }
        #confirmDeleteModal .modal-body { padding: 20px 0; color: var(--text-secondary); font-size: 1rem; }
        #confirmDeleteModal .modal-footer { display: flex; justify-content: center; gap: 15px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        #commandsGuideModal .modal-content { max-width: 900px; }
        #agenda-view { display: none; }
        #agenda-card-content { max-height: none; min-height: 600px; }
        #calendar { --fc-bg-event-color: var(--accent-purple); --fc-border-color: var(--border-color); --fc-today-bg-color: rgba(59, 130, 246, 0.15); --fc-button-bg-color: var(--bg-secondary); --fc-button-active-bg-color: var(--accent-blue); --fc-button-text-color: var(--text-primary); --fc-button-hover-bg-color: var(--bg-card); --fc-list-event-dot-width: 10px; --fc-list-event-hover-bg-color: var(--bg-secondary); }
        .fc-toolbar-title { color: var(--text-primary); }
        .fc-daygrid-day-number { color: var(--text-secondary); }
        .fc-col-header-cell-cushion { color: var(--text-secondary); }
        .fc-event-title { font-weight: 600; }
        .customize-btn { position: fixed; bottom: 90px; right: 20px; width: 50px; height: 50px; background: linear-gradient(135deg, var(--accent-purple), var(--accent-orange)); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: var(--shadow-lg); cursor: pointer; transition: var(--transition); z-index: 1001; border: none; }
        @media (min-width: 768px) { .customize-btn { bottom: 100px; right: 30px; width: 60px; height: 60px; font-size: 1.8rem; } }
        .customize-btn:hover { transform: scale(1.05) translateY(-5px); box-shadow: 0 15px 25px rgba(139, 92, 246, 0.4); }
        #customizeModal .modal-content { max-width: 500px; }
        #card-visibility-list { list-style: none; padding: 0; margin-top: 20px; }
        #card-visibility-list li { padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        #card-visibility-list li:last-child { border-bottom: none; }
        #card-visibility-list label { display: flex; align-items: center; cursor: pointer; font-size: 1rem; color: var(--text-secondary); }
        #card-visibility-list input[type="checkbox"] { margin-right: 15px; width: 1.2em; height: 1.2em; accent-color: var(--accent-teal); }
        .reconciliation-results { margin-top: 32px; }
        .result-section { margin-bottom: 24px; }
        .result-section h4 { font-size: 1.1rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); }
        .tx-item { display: grid; grid-template-columns: 50px 1fr 120px; gap: 16px; align-items: center; padding: 12px; border-radius: var(--border-radius-sm); transition: background-color 0.2s; }
        .tx-item:hover { background-color: var(--bg-secondary); }
        .tx-item-import { grid-template-columns: 30px 50px 1fr 120px; }
        .tx-icon { font-size: 1.2rem; text-align: center; }
        .tx-value { font-weight: 600; text-align: right; }    
        .investment-item { display: grid; grid-template-columns: 1fr auto; align-items: center; padding: 16px 0; border-bottom: 1px solid rgba(var(--border-color-light), 0.5); }
        .investment-item:last-child { border-bottom: none; }
        .investment-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 16px; }
        .investment-name { font-weight: 600; color: var(--text-primary); grid-column: 1 / -1; }
        .investment-meta { font-size: 0.85rem; color: var(--text-muted); }
        .investment-values { text-align: right; }
        .investment-current-value { font-weight: 700; font-size: 1.1rem; color: var(--text-primary); margin-bottom: 4px; }
        .investment-pnl { font-size: 0.9rem; font-weight: 600; }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <!-- Ícone do Hambúrguer para Mobile -->
        <div class="hamburger-menu" id="hamburger-menu">
            <i class="fas fa-bars"></i>
        </div>

        <!-- Overlay para o menu mobile -->
        <div class="overlay" id="sidebar-overlay"></div>

        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                 <!-- LOGO E NOME ATUALIZADOS -->
                <div class="flex items-center justify-center gap-3 mb-2">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-green-400 rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-play text-2xl text-white -mr-1"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white">Zaq</h2>
                </div>
                <p class="text-sm text-gray-400">O seu agente financeiro</p>
            </div>
            <ul class="sidebar-nav">
                <li><a id="show-dashboard-view" class="active"><i class="fas fa-tachometer-alt"></i> <span>Visão Geral</span></a></li>
                <!-- ITEM DE MENU CORRIGIDO -->
                <li><a id="show-reconciliation-view"><i class="fas fa-file-import"></i> <span>Conciliação Bancária</span></a></li>
                <li><a id="show-agenda-view"><i class="fas fa-calendar-alt"></i> <span>Agenda</span></a></li>
                <li><a id="open-commands-guide-btn"><i class="fas fa-book"></i> <span>Guia de Comandos</span></a></li>
            </ul>
        </nav>

        <!-- Main Content Area -->
        <div class="main-content-area" id="main-content">
            <div class="container">
                
                <!-- VISTA DO DASHBOARD FINANCEIRO (EXISTENTE) -->
                <div id="dashboard-view">
                    <!-- Header -->
                    <div class="header">
                        <div class="header-left">
                            <h1><i class="fas fa-chart-line"></i> Dashboard Financeiro</h1>
                            <p>Controle inteligente das suas finanças pessoais</p>
                        </div>
                        <div class="header-right">
                            <div class="filter-controls">
                                <select id="month-select">
                                    <option value="0">Janeiro</option>
                                    <option value="1">Fevereiro</option>
                                    <option value="2">Março</option>
                                    <option value="3">Abril</option>
                                    <option value="4">Maio</option>
                                    <option value="5">Junho</option>
                                    <option value="6">Julho</option>
                                    <option value="7">Agosto</option>
                                    <option value="8">Setembro</option>
                                    <option value="9">Outubro</option>
                                    <option value="10">Novembro</option>
                                    <option value="11">Dezembro</option>
                                </select>
                                <input type="number" id="year-input" min="2020" max="2030">
                                <button class="refresh-btn btn-primary" onclick="loadDashboardData()">
                                    <i class="fas fa-filter"></i>
                                    Aplicar Filtro
                                </button>
                            </div>
                            <div class="last-update">
                                <div>Última atualização</div>
                                <div id="last-update-time">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div class="loading" id="loading">
                        <i class="fas fa-spinner"></i>
                        <div>Carregando dados financeiros...</div>
                    </div>

                    <!-- Error Container -->
                    <div id="error-container"></div>

                    <!-- Container para todos os cards -->
                    <div id="dashboard-content-container">
                        <div class="summary-grid" style="margin-bottom: 32px;">
                            <div class="summary-card receitas" id="card-receitas">
                                <div class="summary-header"><div class="summary-icon receitas"><i class="fas fa-arrow-up"></i></div></div>
                                <div class="summary-value" id="total-receitas">R$ 0,00</div>
                                <div class="summary-label">Receitas do Mês</div>
                            </div>
                            <div class="summary-card despesas" id="card-despesas">
                                <div class="summary-header"><div class="summary-icon despesas"><i class="fas fa-arrow-down"></i></div></div>
                                <div class="summary-value" id="total-despesas">R$ 0,00</div>
                                <div class="summary-label">Despesas do Mês</div>
                            </div>
                            <div class="summary-card saldo" id="card-saldo">
                                <div class="summary-header"><div class="summary-icon saldo"><i class="fas fa-wallet"></i></div></div>
                                <div class="summary-value" id="saldo-liquido">R$ 0,00</div>
                                <div class="summary-label">Saldo Líquido</div>
                            </div>
                            <div class="summary-card saldo" id="card-patrimonio">
                                <div class="summary-header"><div class="summary-icon saldo"><i class="fas fa-balance-scale"></i></div></div>
                                <div class="summary-value" id="patrimonio-liquido">R$ 0,00</div>
                                <div class="summary-label">Patrimônio Líquido</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px; display: flex; justify-content: space-between;">
                                    <span class="positive" id="total-ativos-summary">Ativos: R$ 0,00</span>
                                    <span class="negative" id="total-passivos-summary">Passivos: R$ 0,00</span>
                                </div>
                            </div>
                        </div>

                        <div class="card" id="card-contas" style="margin-bottom: 32px;">
                            <div class="card-header" style="justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center;">
                                    <div class="card-icon" style="background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));"><i class="fas fa-university"></i></div>
                                    <div class="card-title">Minhas Contas</div>
                                </div>
                                <button class="btn btn-primary" id="add-account-btn" style="padding: 8px 16px; font-size: 0.9rem;"><i class="fas fa-plus"></i> Nova Conta</button>
                            </div>
                            <div class="card-content">
                                <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--border-radius-sm); margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: var(--text-secondary); font-weight: 500;">Saldo Total Consolidado</span>
                                    <span id="saldo-consolidado" style="font-size: 1.5rem; font-weight: 700; color: var(--accent-green);">R$ 0,00</span>
                                </div>
                                <div id="account-balances-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;"></div>
                                <div id="account-balances-empty" class="empty-state" style="display: none;"><i class="fas fa-coins"></i><div>Nenhuma conta encontrada</div></div>
                            </div>
                        </div>

                        <div class="main-grid">
                            <div class="left-column">
                                <div class="card" id="card-despesas-categoria"><div class="card-header"><div class="card-icon" style="background: linear-gradient(135deg, var(--accent-blue), var(--accent-teal));"><i class="fas fa-chart-bar"></i></div><div class="card-title">Despesas por Categoria</div></div><div class="card-content"><div class="chart-container"><canvas id="expenses-chart"></canvas></div><div id="expenses-chart-empty" class="empty-state" style="display: none;"><i class="fas fa-chart-bar"></i><div>Nenhum dado de despesas para o gráfico.</div></div></div></div>
                                <!-- NOVO CARD: EVOLUÇÃO DA CARTEIRA -->
                                <div class="card" id="card-evolucao-carteira">
                                    <div class="card-header">
                                        <div class="card-icon" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));">
                                            <i class="fas fa-chart-area"></i>
                                        </div>
                                        <div class="card-title">Evolução da Carteira</div>
                                    </div>
                                    <div class="card-content">
                                        <div class="chart-container" style="height: 300px;">
                                            <canvas id="portfolio-evolution-chart"></canvas>
                                        </div>
                                        <div id="portfolio-evolution-empty" class="empty-state" style="display: none;">
                                            <i class="fas fa-history"></i>
                                            <div>Ainda não há histórico suficiente para gerar o gráfico.</div>
                                        </div>
                                    </div>
                                </div>
                                                         
                                
                                <div class="card" id="card-investimentos">
                                    <div class="card-header">
                                        <div class="card-icon" style="background: linear-gradient(135deg, var(--accent-green), #6EE7B7);">
                                            <i class="fas fa-seedling"></i>
                                        </div>
                                        <div class="card-title">Carteira de Investimentos</div>
                                    </div>
                                    <div class="card-content">
                                        <div id="investments-summary" style="padding: 16px; background: var(--bg-secondary); border-radius: var(--border-radius-sm); margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
                                            <span style="color: var(--text-secondary); font-weight: 500;">Valor Total da Carteira</span>
                                            <span id="investments-total-value" style="font-size: 1.5rem; font-weight: 700; color: var(--accent-green);">R$ 0,00</span>
                                        </div>
                                        <div id="investments-list"></div>
                                        <div id="investments-empty" class="empty-state" style="display: none;"><i class="fas fa-chart-line"></i><div>Nenhum investimento encontrado.</div></div>
                                    </div>
                                </div>
                                <div class="card" id="card-orcamento"><div class="card-header"><div class="card-icon" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));"><i class="fas fa-chart-pie"></i></div><div class="card-title">Progresso do Orçamento</div></div><div class="card-content"><div class="chart-container" id="budget-chart-container"><canvas id="budget-chart"></canvas></div><div id="budget-chart-empty" class="empty-state" style="display: none;"><i class="fas fa-calculator"></i><div>Nenhum orçamento definido para o gráfico.</div></div></div></div>
                                <div class="card" id="card-necessidades-desejos">
                                    <div class="card-header">
                                        <div class="card-icon" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-orange));">
                                            <i class="fas fa-balance-scale-right"></i>
                                        </div>
                                        <div class="card-title">Necessidades vs. Desejos</div>
                                    </div>
                                    <div class="card-content">
                                        <div class="chart-container" style="min-height: 280px;">
                                            <canvas id="needs-wants-chart"></canvas>
                                        </div>
                                        <div id="needs-wants-empty" class="empty-state" style="display: none;"><i class="fas fa-question-circle"></i><div>Sem dados para análise.</div></div>
                                    </div>
                                </div>
                            </div>
                            <div class="right-column">
                                <div class="card" id="card-transacoes-recentes"><div class="card-header"><div class="card-icon" style="background: linear-gradient(135deg, var(--accent-teal), var(--accent-green));"><i class="fas fa-exchange-alt"></i></div><div class="card-title">Lançamentos Recentes</div></div><div class="card-content"><div id="recent-transactions"><div class="empty-state"><i class="fas fa-history"></i><div>Nenhuma transação encontrada</div></div></div></div></div>
                                <div class="card" id="card-contas-a-pagar"><div class="card-header"><div class="card-icon" style="background: linear-gradient(135deg, var(--accent-red), var(--accent-orange));"><i class="fas fa-file-invoice-dollar"></i></div><div class="card-title">Contas a Pagar</div></div><div class="card-content"><div id="bills-to-pay"><div class="empty-state"><i class="fas fa-calendar-check"></i><div>Nenhuma conta pendente</div></div></div></div></div>
                                <div class="card" id="card-cartoes-credito"><div class="card-header"><div class="card-icon" style="background: linear-gradient(135deg, var(--accent-orange), var(--accent-red));"><i class="fas fa-credit-card"></i></div><div class="card-title">Cartões de Crédito</div></div><div class="card-content"><div id="credit-cards"><div class="empty-state"><i class="fas fa-credit-card"></i><div>Nenhum cartão encontrado</div></div></div></div></div>
                                <div class="card" id="card-metas"><div class="card-header"><div class="card-icon" style="background: linear-gradient(135deg, var(--accent-green), var(--accent-teal));"><i class="fas fa-bullseye"></i></div><div class="card-title">Progresso das Metas</div></div><div class="card-content"><div id="goals-progress"><div class="empty-state"><i class="fas fa-target"></i><div>Nenhuma meta definida</div></div></div></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VISTA DA CONCILIAÇÃO BANCÁRIA (CORRIGIDA) -->
                <div id="reconciliation-view" style="display: none;">
                    <div class="header">
                        <div class="header-left">
                            <h1><i class="fas fa-file-import"></i> Conciliação Bancária</h1>
                            <p>Importe seu extrato (CSV ou OFX) para encontrar transações não lançadas.</p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-orange));"><i class="fas fa-upload"></i></div>
                            <h2 class="card-title">1. Enviar Extrato</h2>
                        </div>
                        <div class="card-content">
                            <p class="text-muted" style="margin-bottom: 20px;">Selecione o arquivo do seu extrato bancário. O sistema tentará identificar as colunas e transações automaticamente.</p>
                            <div class="form-group">
                                <label for="statement-file-input">Arquivo de Extrato (.csv, .ofx)</label>
                                <!-- CORREÇÃO APLICADA AQUI -->
                                <input type="file" id="statement-file-input" accept=".csv,.ofx,text/csv,application/x-ofx">
                            </div>
                            <button id="process-statement-btn" class="btn btn-primary">
                                <i class="fas fa-cogs"></i> Processar Arquivo
                            </button>
                        </div>
                    </div>

                    <div id="reconciliation-results-container" class="card" style="display: none;">
                         <div class="card-header">
                            <div class="card-icon" style="background: linear-gradient(135deg, var(--accent-teal), var(--accent-green));"><i class="fas fa-tasks"></i></div>
                            <h2 class="card-title">2. Revisar e Importar</h2>
                        </div>
                        <div class="card-content">
                            <div id="reconciliation-loading" style="display: none;" class="loading">
                                <i class="fas fa-spinner"></i>
                                <div>Analisando transações...</div>
                            </div>
                            <div id="reconciliation-results">
                                <!-- Os resultados serão inseridos aqui pelo JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>



                <!-- NOVA VISTA DA AGENDA -->
                <div id="agenda-view" style="display: none;">
                    <div class="header">
                        <div class="header-left">
                            <h1><i class="fas fa-calendar-alt"></i> Agenda de Tarefas</h1>
                            <p>Visualize os seus compromissos e lembretes.</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-content" id="agenda-card-content" style="padding: 24px;">
                            <div id="calendar"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- NOVO: Botão de Personalizar -->
    <button class="customize-btn" id="customize-dashboard-btn" title="Personalizar Dashboard">
        <i class="fas fa-palette"></i>
    </button>

    <!-- Floating Action Button -->
    <button class="fab" id="add-transaction-fab" title="Adicionar Novo Lançamento">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Modal para Adicionar/Editar Transação -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeModalBtn">&times;</span>
            <div class="modal-header">
                <h3 id="transactionModalTitle">Adicionar Novo Lançamento</h3>
            </div>
            <form id="transactionForm">
                <input type="hidden" id="transactionId">
                <div class="form-group"><label for="transactionDate">Data</label><input type="date" id="transactionDate" required></div>
                <div class="form-group"><label for="transactionDescription">Descrição</label><textarea id="transactionDescription" placeholder="Ex: Supermercado, Salário, Conta de Luz" required></textarea></div>
                <div class="form-group"><label for="transactionType">Tipo</label><select id="transactionType" required><option value="">Selecione o tipo</option><option value="Despesa">Despesa</option><option value="Receita">Receita</option><option value="Transferência">Transferência</option></select></div>
                <div class="form-group"><label for="transactionValue">Valor (R$)</label><input type="number" id="transactionValue" step="0.01" min="0.01" required></div>
                <div class="form-group"><label for="transactionAccount">Conta/Cartão</label><select id="transactionAccount" required><option value="">Carregando contas...</option></select></div>
                <div class="form-group" id="category-group" style="display: none;"><label for="transactionCategory">Categoria</label><select id="transactionCategory"><option value="">Carregando categorias...</option></select></div>
                <div class="form-group" id="subcategory-group" style="display: none;"><label for="transactionSubcategory">Subcategoria</label><select id="transactionSubcategory"><option value="">Selecione a subcategoria</option></select></div>
                <div class="form-group" id="payment-method-group" style="display: none;"><label for="transactionPaymentMethod">Método de Pagamento</label><select id="transactionPaymentMethod"><option value="">Carregando métodos...</option></select></div>
                <div class="form-group" id="installments-group"><label for="transactionInstallments">Parcelas (1 para à vista)</label><input type="number" id="transactionInstallments" min="1" value="1"></div>
                <div class="form-group" id="dueDate-group" style="display: none;"><label for="dueDate">Data de Vencimento (Opcional)</label><input type="date" id="dueDate"></div>
                <div class="form-actions"><button type="button" class="btn btn-secondary" id="cancelFormBtn">Cancelar</button><button type="submit" class="btn btn-primary">Salvar Lançamento</button></div>
            </form>
        </div>
    </div>

    <div id="accountModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeAccountModalBtn">&times;</span>
            <div class="modal-header"><h3 id="accountModalTitle">Nova Conta</h3></div>
            <form id="accountForm">
                <input type="hidden" id="originalAccountName">
                <div class="form-group"><label for="accountName">Nome da Conta</label><input type="text" id="accountName" placeholder="Ex: Conta Corrente Nubank" required></div>
                <div class="form-group"><label for="accountType">Tipo</label><select id="accountType" required><option value="Conta Corrente">Conta Corrente</option><option value="Dinheiro Físico">Dinheiro Físico</option></select></div>
                <div class="form-group"><label for="accountBank">Banco / Instituição</label><input type="text" id="accountBank" placeholder="Ex: Nubank, Inter, Carteira"></div>
                <div class="form-group"><label for="accountInitialBalance">Saldo Inicial (R$)</label><input type="number" id="accountInitialBalance" step="0.01" required></div>
                <div class="form-actions"><button type="button" class="btn btn-secondary" id="cancelAccountFormBtn">Cancelar</button><button type="submit" class="btn btn-primary">Salvar</button></div>
            </form>
        </div>
    </div>

    <div id="confirmDeleteModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeDeleteModalBtn">&times;</span>
            <div class="modal-header"><h3 id="confirmDeleteModalTitle">Confirmar Exclusão</h3></div>
            <div class="modal-body"><p id="confirmDeleteModalText">Tem certeza que deseja excluir este item?</p></div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Cancelar</button><button type="button" class="btn btn-primary delete-btn" id="confirmDeleteBtn">Excluir</button></div>
        </div>
    </div>

    <div id="categoryDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeCategoryModalBtn">&times;</span>
            <div class="modal-header"><h3 id="categoryModalTitle">Detalhes da Categoria</h3></div>
            <div class="modal-body">
                <div class="loading" id="category-modal-loading" style="display: none; height: 200px;"><i class="fas fa-spinner"></i><div>Buscando transações...</div></div>
                <div id="category-transactions-list"></div>
            </div>
        </div>
    </div>

    <div id="commandsGuideModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeCommandsGuideBtn">&times;</span>
            <div class="modal-body" id="commandsGuideContent"><div class="loading" style="height: 400px;"><i class="fas fa-spinner"></i><div>A carregar guia...</div></div></div>
        </div>
    </div>

    <!-- NOVO: Modal para Personalizar Dashboard -->
    <div id="customizeModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeCustomizeModalBtn">&times;</span>
            <div class="modal-header">
                <h3>Personalizar Visibilidade</h3>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); margin-bottom: 10px;">Marque os cards que deseja exibir no seu dashboard.</p>
                <ul id="card-visibility-list">
                    <!-- Checkboxes serão populados pelo JavaScript -->
                </ul>
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" id="saveLayoutBtn">Salvar e Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="feedback-message" class="hidden"><span id="feedback-icon"></span><span id="feedback-text"></span></div>

    <script>
        // Todo o seu JavaScript existente...
        let expensesChartInstance = null;
        let budgetChartInstance = null;
        let needsWantsChartInstance = null;
        let portfolioEvolutionChartInstance = null; 
        let calendarInstance = null;
        Chart.register(ChartDataLabels);
        let allAccounts = [];
        let allDashboardAccounts = [];
        let allCategories = {};
        let allPaymentMethods = [];
        let allTransactions = [];
        function formatCurrency(value) { const numericValue = typeof value === 'string' ? parseFloat(value.replace(/[^0-9,-]+/g,"").replace(",", ".")) : value; if (isNaN(numericValue)) return "R$ 0,00"; return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(numericValue); }
        function showFeedback(message, type) { const feedbackMessage = document.getElementById('feedback-message'); const feedbackIcon = document.getElementById('feedback-icon'); const feedbackText = document.getElementById('feedback-text'); feedbackMessage.classList.remove('success', 'error', 'show'); feedbackMessage.classList.add(type); feedbackText.textContent = message; if (type === 'success') { feedbackIcon.innerHTML = '<i class="fas fa-check-circle"></i>'; } else if (type === 'error') { feedbackIcon.innerHTML = '<i class="fas fa-times-circle"></i>'; } feedbackMessage.classList.add('show'); setTimeout(() => { feedbackMessage.classList.remove('show'); }, 3000); }
        function showError(message) { const errorContainer = document.getElementById('error-container'); errorContainer.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i><strong>Erro:</strong> ${message}</div>`; }
        function clearError() { document.getElementById('error-container').innerHTML = ''; }
        function showLoading() { document.getElementById('loading').style.display = 'flex'; document.getElementById('dashboard-content-container').style.display = 'none'; clearError(); }
        function hideLoading() { document.getElementById('loading').style.display = 'none'; const content = document.getElementById('dashboard-content-container'); content.style.display = 'block'; }
        function updateLastUpdateTime(month, year) { const now = new Date(); const timeString = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }); const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"]; document.getElementById('last-update-time').textContent = `${monthNames[month]}/${year} - ${timeString}`; }
        
        function wrapLabel(label, maxWidth = 15) {
            if (typeof label !== 'string') return label;
            if (label.length <= maxWidth) return label;
            const words = label.split(' ');
            let lines = [];
            let currentLine = '';
            for (const word of words) {
                if ((currentLine + ' ' + word).trim().length > maxWidth) {
                    lines.push(currentLine.trim());
                    currentLine = word;
                } else {
                    currentLine = (currentLine + ' ' + word).trim();
                }
            }
            if (currentLine) lines.push(currentLine.trim());
            return lines;
        }

        function renderSummary(summary) { document.getElementById('total-receitas').textContent = formatCurrency(summary.totalReceitas); document.getElementById('total-despesas').textContent = formatCurrency(summary.totalDespesas); const saldoElement = document.getElementById('saldo-liquido'); saldoElement.textContent = formatCurrency(summary.saldoLiquidoMes); saldoElement.classList.remove('positive', 'negative', 'neutral'); if (summary.saldoLiquidoMes > 0) saldoElement.classList.add('positive'); else if (summary.saldoLiquidoMes < 0) saldoElement.classList.add('negative'); else saldoElement.classList.add('neutral'); }
        function renderNetWorth(netWorthData) { if (!netWorthData) return; const netWorthElement = document.getElementById('patrimonio-liquido'); const assetsElement = document.getElementById('total-ativos-summary'); const liabilitiesElement = document.getElementById('total-passivos-summary'); netWorthElement.textContent = formatCurrency(netWorthData.netWorth); assetsElement.textContent = `Ativos: ${formatCurrency(netWorthData.assets)}`; liabilitiesElement.textContent = `Passivos: ${formatCurrency(netWorthData.liabilities)}`; netWorthElement.classList.remove('positive', 'negative', 'neutral'); if (netWorthData.netWorth > 0) { netWorthElement.classList.add('positive'); } else if (netWorthData.netWorth < 0) { netWorthElement.classList.add('negative'); } else { netWorthElement.classList.add('neutral'); } }
        function renderAccountBalances(accounts) { const gridContainer = document.getElementById('account-balances-grid'); const emptyState = document.getElementById('account-balances-empty'); const saldoConsolidadoEl = document.getElementById('saldo-consolidado'); allDashboardAccounts = accounts || []; if (!accounts || accounts.length === 0) { gridContainer.innerHTML = ''; emptyState.style.display = 'flex'; saldoConsolidadoEl.textContent = formatCurrency(0); return; } emptyState.style.display = 'none'; const totalBalance = accounts.reduce((sum, acc) => sum + acc.saldo, 0); saldoConsolidadoEl.textContent = formatCurrency(totalBalance); gridContainer.innerHTML = accounts.map(account => ` <div class="summary-card" style="padding: 16px; border-radius: var(--border-radius-sm);"> <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;"> <div> <div class="account-name" style="font-size: 1.1rem;">${account.nomeOriginal}</div> <div class="account-type" style="font-size: 0.8rem;">${account.banco || account.tipo}</div> </div> <div class="account-actions" style="display: flex; gap: 8px;"> <button class="edit-account-btn" data-name="${account.nomeOriginal}" title="Editar Conta" style="background:none; border:none; color: var(--text-muted); cursor:pointer; font-size: 0.9rem;"><i class="fas fa-edit"></i></button> <button class="delete-account-btn" data-name="${account.nomeOriginal}" title="Excluir Conta" style="background:none; border:none; color: var(--text-muted); cursor:pointer; font-size: 0.9rem;"><i class="fas fa-trash-alt"></i></button> </div> </div> <div class="account-balance ${account.saldo >= 0 ? 'positive' : 'negative'}" style="font-size: 1.75rem; font-weight: 700;"> ${formatCurrency(account.saldo)} </div> </div> `).join(''); document.querySelectorAll('.edit-account-btn').forEach(btn => { btn.addEventListener('click', handleEditAccount); }); document.querySelectorAll('.delete-account-btn').forEach(btn => { btn.addEventListener('click', handleDeleteAccount); }); }
        
        function renderInvestments(investments) {
            const container = document.getElementById('investments-list');
            const emptyState = document.getElementById('investments-empty');
            const totalValueEl = document.getElementById('investments-total-value');

            if (!investments || investments.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'flex';
                totalValueEl.textContent = formatCurrency(0);
                return;
            }

            emptyState.style.display = 'none';
            const totalValue = investments.reduce((sum, asset) => sum + asset.valorAtual, 0);
            totalValueEl.textContent = formatCurrency(totalValue);

            container.innerHTML = investments.sort((a,b) => b.valorAtual - a.valorAtual).map(asset => {
                const pnl = asset.lucroPrejuizo;
                const pnlClass = pnl > 0 ? 'positive' : (pnl < 0 ? 'negative' : 'neutral');
                const pnlSign = pnl > 0 ? '+' : '';
                
                return `
                    <div class="investment-item">
                        <div class="investment-info-grid">
                            <div class="investment-name">${asset.ativo} (${asset.tipo})</div>
                            <div class="investment-meta">Qtd: ${asset.quantidade}</div>
                            <div class="investment-meta">Preço Médio: ${formatCurrency(asset.precoMedio)}</div>
                        </div>
                        <div class="investment-values">
                            <div class="investment-current-value">${formatCurrency(asset.valorAtual)}</div>
                            <div class="investment-pnl ${pnlClass}">${pnlSign}${formatCurrency(pnl)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCreditCards(cards) { const container = document.getElementById('credit-cards'); if (!cards || cards.length === 0) { container.innerHTML = `<div class="empty-state"><i class="fas fa-credit-card"></i><div>Nenhum cartão encontrado</div></div>`; return; } container.innerHTML = cards.map(card => { const valorExibido = card.faturaAtual; const utilizacao = card.limite > 0 ? (valorExibido / card.limite) * 100 : 0; const isHighUsage = utilizacao > 80; return `<div class="credit-card"><div class="card-header-info"><div class="card-name">${card.nomeOriginal}</div><div class="card-limit">Limite: ${formatCurrency(card.limite)}</div></div><div class="usage-bar"><div class="usage-fill ${isHighUsage ? 'high' : ''}" style="width: ${Math.min(utilizacao, 100)}%"></div></div><div class="usage-info"><span class="usage-percentage">${utilizacao.toFixed(1)}% utilizado</span><span class="usage-amount ${valorExibido > card.limite ? 'negative' : ''}">${formatCurrency(valorExibido)}</span></div></div>`; }).join(''); }
        function renderRecentTransactions(transactions, newTransactionId = null) { const container = document.getElementById('recent-transactions'); if (!transactions || transactions.length === 0) { container.innerHTML = `<div class="empty-state"><i class="fas fa-history"></i><div>Nenhuma transação encontrada</div></div>`; return; } container.innerHTML = transactions.map(transaction => { const highlightClass = transaction.id === newTransactionId ? 'highlight' : ''; return ` <div class="transaction-item ${highlightClass}" data-id="${transaction.id}"> <div class="transaction-icon ${transaction.tipo.toLowerCase()}"> <i class="fas fa-${transaction.tipo === 'Receita' ? 'arrow-up' : 'arrow-down'}"></i> </div> <div class="transaction-details"> <div class="transaction-desc">${transaction.descricao}</div> <div class="transaction-meta">${transaction.data} • ${transaction.categoria} • ${transaction.conta}</div> </div> <div class="transaction-amount ${transaction.tipo === 'Receita' ? 'positive' : 'negative'}"> ${transaction.tipo === 'Receita' ? '+' : '-'}${formatCurrency(Math.abs(transaction.valor))} </div> <div class="transaction-actions"> <button class="edit-transaction-btn" data-id="${transaction.id}" title="Editar Lançamento"><i class="fas fa-edit"></i></button> <button class="delete-transaction-btn" data-id="${transaction.id}" title="Excluir Lançamento"><i class="fas fa-trash-alt"></i></button> </div> </div> `; }).join(''); document.querySelectorAll('.edit-transaction-btn').forEach(button => button.addEventListener('click', (event) => { const transactionId = event.currentTarget.dataset.id; const transactionToEdit = allTransactions.find(t => t.id === transactionId); if (transactionToEdit) openEditTransactionModal(transactionToEdit); else showFeedback('Erro: Não foi possível encontrar os dados desta transação para editar.', 'error'); })); document.querySelectorAll('.delete-transaction-btn').forEach(button => button.addEventListener('click', (event) => confirmDeleteTransaction(event.currentTarget.dataset.id, 'Lançamento'))); }
        function renderBillsToPay(bills) { const container = document.getElementById('bills-to-pay'); if (!bills || bills.length === 0) { container.innerHTML = `<div class="empty-state"><i class="fas fa-calendar-check"></i><div>Nenhuma conta pendente</div></div>`; return; } container.innerHTML = bills.map(bill => `<div class="bill-item"><div class="bill-info"><div class="bill-desc">${bill.descricao}</div><div class="bill-due">Vencimento: ${bill.dataVencimento}</div></div><div style="text-align: right;"><div class="bill-amount">${formatCurrency(bill.valor)}</div><span class="status-badge status-${bill.status.toLowerCase()}">${bill.status}</span></div></div>`).join(''); }
        function renderGoalsProgress(goals) { const container = document.getElementById('goals-progress'); if (!goals || goals.length === 0) { container.innerHTML = `<div class="empty-state"><i class="fas fa-target"></i><div>Nenhuma meta definida</div></div>`; return; } container.innerHTML = goals.map(goal => `<div class="progress-item"><div class="progress-header"><span class="progress-label">${goal.icon ? goal.icon + ' ' : ''}${goal.categoria}</span><span class="progress-percentage">${goal.percentage.toFixed(1)}%</span></div><div class="progress-bar"><div class="progress-fill ${goal.percentage > 100 ? 'over-budget' : ''}" style="width: ${Math.min(goal.percentage, 100)}%"></div></div><div class="progress-values"><span>Salvo: ${formatCurrency(goal.gasto)}</span><span>Meta: ${formatCurrency(goal.meta)}</span></div></div>`).join(''); }
        
        function renderExpenseChart(expensesByCategory) { 
            const chartCanvas = document.getElementById('expenses-chart'); 
            const emptyState = document.getElementById('expenses-chart-empty'); 
            const chartContainer = document.getElementById('card-despesas-categoria').querySelector('.chart-container'); 
            if (!expensesByCategory || expensesByCategory.length === 0 || expensesByCategory.every(item => item.value === 0)) { 
                if(expensesChartInstance) expensesChartInstance.destroy();
                chartCanvas.style.display = 'none'; 
                emptyState.style.display = 'flex'; 
                chartContainer.style.height = 'auto'; 
                return; 
            } 
            chartCanvas.style.display = 'block'; 
            emptyState.style.display = 'none'; 
            const sortedData = [...expensesByCategory].sort((a, b) => b.value - a.value); const categories = sortedData.map(item => item.category); const values = sortedData.map(item => item.value); const icons = sortedData.map(item => item.icon); const dynamicHeight = Math.max(300, categories.length * 40); chartContainer.style.height = `${dynamicHeight}px`; let yAxisFontSize = categories.length > 15 ? 9 : (categories.length > 10 ? 10 : 11); const backgroundColors = ['#8B5CF6', '#3B82F6', '#14B8A6', '#10B981', '#F59E0B', '#EF4444', '#6366F1', '#EC4899', '#F97316', '#A855F7', '#06B6D4', '#F43F5E']; const chartData = { labels: categories.map((cat, index) => icons[index] ? wrapLabel(`${icons[index]} ${cat}`) : wrapLabel(cat)), datasets: [{ data: values, backgroundColor: backgroundColors.slice(0, categories.length), borderWidth: 1 }] }; const chartOptions = { indexAxis: 'y', responsive: true, maintainAspectRatio: false, layout: { padding: { left: 20, right: 50 } }, onClick: (event, elements) => { if (elements.length > 0) { const index = elements[0].index; const categoryLabelWithIcon = expensesChartInstance.data.labels[index]; let cleanCategoryName = Array.isArray(categoryLabelWithIcon) ? categoryLabelWithIcon.join(' ') : categoryLabelWithIcon; cleanCategoryName = cleanCategoryName.replace(/(\p{Emoji}|\p{Emoji_Modifier_Base}|\p{Emoji_Component}|\p{Emoji_Modifier}|\p{Emoji_Presentation})\s*/u, '').trim(); const selectedMonth = parseInt(document.getElementById('month-select').value) + 1; const selectedYear = parseInt(document.getElementById('year-input').value); const categoryModal = document.getElementById('categoryDetailModal'); categoryModal.classList.add('show'); document.getElementById('category-modal-loading').style.display = 'flex'; document.getElementById('category-transactions-list').innerHTML = ''; document.getElementById('categoryModalTitle').textContent = `Transações de ${cleanCategoryName}`; if (typeof google !== 'undefined' && google.script && google.script.run) { google.script.run.withSuccessHandler(transactions => { document.getElementById('category-modal-loading').style.display = 'none'; populateCategoryModal(transactions); }).withFailureHandler(error => { document.getElementById('category-modal-loading').style.display = 'none'; document.getElementById('category-transactions-list').innerHTML = `<div class="error-message">Erro ao buscar transações.</div>`; console.error("Erro:", error); }).getTransactionsByCategory(cleanCategoryName, selectedMonth, selectedYear); } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { let label = Array.isArray(context.label) ? context.label.join(' ') : (context.label || ''); label = label.replace(/(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])/g, '').trim(); if (label) { label += ': '; } if (context.parsed.x !== null) { label += formatCurrency(context.parsed.x); } return label; } } }, datalabels: { clamp: true, color: '#F8FAFC', anchor: 'end', align: 'end', offset: 4, font: { weight: 'bold', size: 12, family: 'Inter' }, formatter: (value, ctx) => value > 0 ? formatCurrency(value) : '', display: function(context) { const bar = context.chart.getDatasetMeta(context.datasetIndex).data[context.dataIndex]; return (bar.width || (bar.x - bar.base)) > 20; } } }, scales: { x: { ticks: { color: '#CBD5E1', font: { family: 'Inter' }, callback: value => formatCurrency(value) }, grid: { color: 'rgba(71, 85, 105, 0.3)' }, border: { color: 'var(--border-color)' } }, y: { ticks: { color: '#F8FAFC', font: { family: 'Inter', size: yAxisFontSize } }, grid: { display: false }, border: { color: 'var(--border-color)' } } } }; if (expensesChartInstance) expensesChartInstance.destroy(); expensesChartInstance = new Chart(chartCanvas, { type: 'bar', data: chartData, options: chartOptions }); 
        }
        
        function renderBudgetProgress(budget) { 
            const chartCanvas = document.getElementById('budget-chart'); 
            const emptyState = document.getElementById('budget-chart-empty'); 
            const chartContainer = document.getElementById('card-orcamento').querySelector('.chart-container');
            if (!budget || budget.length === 0 || budget.every(item => item.orcado === 0 && item.gasto === 0)) { 
                if(budgetChartInstance) budgetChartInstance.destroy();
                chartCanvas.style.display = 'none'; 
                emptyState.style.display = 'flex'; 
                chartContainer.style.height = 'auto'; 
                return; 
            } 
            chartCanvas.style.display = 'block'; 
            emptyState.style.display = 'none'; 
            const categoryHeight = 50; const minChartHeight = 300; const dynamicHeight = Math.max(minChartHeight, budget.length * categoryHeight); chartContainer.style.height = `${dynamicHeight}px`; const sortedBudget = [...budget].sort((a, b) => b.orcado - a.orcado); const chartData = { labels: sortedBudget.map(item => item.icon ? wrapLabel(`${item.icon} ${item.categoria}`) : wrapLabel(item.categoria)), datasets: [ { label: 'Orçado', data: sortedBudget.map(item => item.orcado), backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, barPercentage: 0.8, categoryPercentage: 0.6 }, { label: 'Gasto', data: sortedBudget.map(item => item.gasto), backgroundColor: 'rgba(20, 184, 166, 0.7)', borderColor: 'rgba(20, 184, 166, 1)', borderWidth: 1, barPercentage: 0.8, categoryPercentage: 0.6 } ] }; const chartOptions = { indexAxis: 'y', responsive: true, maintainAspectRatio: false, layout: { padding: { left: 20, right: 10 } }, plugins: { legend: { display: true, position: 'top', labels: { color: '#F8FAFC' } }, tooltip: { callbacks: { label: context => `${context.dataset.label}: ${formatCurrency(context.parsed.x)}` } }, datalabels: { display: false } }, scales: { x: { stacked: false, ticks: { color: '#CBD5E1', callback: value => formatCurrency(value) }, grid: { color: 'rgba(71, 85, 105, 0.3)' } }, y: { stacked: false, ticks: { color: '#F8FAFC' } } } }; if (budgetChartInstance) budgetChartInstance.destroy(); budgetChartInstance = new Chart(chartCanvas, { type: 'bar', data: chartData, options: chartOptions }); 
        }
        
        function renderNeedsWantsChart(summary, totalReceitas) { 
            const chartCanvas = document.getElementById('needs-wants-chart'); 
            const emptyState = document.getElementById('needs-wants-empty'); 
            if (!summary || (summary.necessidades === 0 && summary.desejos === 0 && summary.naoClassificado === 0)) { 
                if(needsWantsChartInstance) needsWantsChartInstance.destroy();
                chartCanvas.style.display = 'none'; 
                emptyState.style.display = 'flex'; 
                return; 
            } 
            chartCanvas.style.display = 'block'; 
            emptyState.style.display = 'none'; 
            const poupanca = Math.max(0, totalReceitas - (summary.necessidades + summary.desejos + summary.naoClassificado)); const chartData = { labels: ['Necessidades', 'Desejos', 'Poupança', 'Não Classificado'], datasets: [{ data: [summary.necessidades, summary.desejos, poupanca, summary.naoClassificado], backgroundColor: ['#3B82F6', '#8B5CF6', '#10B981', '#94A3B8'], borderColor: 'var(--bg-card)', borderWidth: 4, hoverOffset: 8 }] }; if (needsWantsChartInstance) needsWantsChartInstance.destroy(); needsWantsChartInstance = new Chart(chartCanvas, { type: 'doughnut', data: chartData, options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'bottom', labels: { color: '#F8FAFC', font: { family: 'Inter', size: 12 }, padding: 20 } }, tooltip: { callbacks: { label: function(context) { let label = context.label || ''; if (label) label += ': '; const value = context.parsed; label += formatCurrency(value); if (totalReceitas > 0) { const percentage = ((value / totalReceitas) * 100).toFixed(1); label += ` (${percentage}%)`; } return label; } } }, datalabels: { display: false } } } }); 
        }
        
        function renderPortfolioEvolutionChart(history) {
            const chartCanvas = document.getElementById('portfolio-evolution-chart');
            const emptyState = document.getElementById('portfolio-evolution-empty');
            const chartContainer = document.getElementById('card-evolucao-carteira').querySelector('.chart-container');

            if (!history || history.length < 2) {
                if(portfolioEvolutionChartInstance) portfolioEvolutionChartInstance.destroy();
                chartCanvas.style.display = 'none';
                emptyState.style.display = 'flex';
                return;
            }
            chartCanvas.style.display = 'block';
            emptyState.style.display = 'none';

            const labels = history.map(item => item.date);
            const data = history.map(item => item.value);

            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'Valor da Carteira',
                    data: data,
                    fill: true,
                    backgroundColor: 'rgba(20, 184, 166, 0.2)',
                    borderColor: 'rgba(20, 184, 166, 1)',
                    tension: 0.3,
                    pointRadius: 2,
                    pointBackgroundColor: 'rgba(20, 184, 166, 1)'
                }]
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: context => `Valor: ${formatCurrency(context.parsed.y)}` } }
                },
                scales: {
                    x: { ticks: { color: '#CBD5E1', maxRotation: 0, autoSkip: true, maxTicksLimit: 7 }, grid: { color: 'rgba(71, 85, 105, 0.1)' } },
                    y: { ticks: { color: '#CBD5E1', callback: value => formatCurrency(value) }, grid: { color: 'rgba(71, 85, 105, 0.3)' } }
                }
            };
            
            if (portfolioEvolutionChartInstance) portfolioEvolutionChartInstance.destroy();
            portfolioEvolutionChartInstance = new Chart(chartCanvas, { type: 'line', data: chartData, options: chartOptions });
        }
        
        function loadDashboardData() { showLoading(); const selectedMonth = parseInt(document.getElementById('month-select').value); const selectedYear = parseInt(document.getElementById('year-input').value); if (typeof google !== 'undefined' && google.script && google.script.run) { google.script.run .withSuccessHandler(function(data) { onSuccess(data, selectedMonth, selectedYear); }) .withFailureHandler(onFailure) .getDashboardData(selectedMonth + 1, selectedYear); } }
        
        function onSuccess(data, selectedMonth, selectedYear, newTransactionId = null) {
            hideLoading();
            allAccounts = data.accounts || [];
            allCategories = data.categories || {};
            allPaymentMethods = data.paymentMethods || [];
            allTransactions = data.recentTransactions || [];
            
            renderSummary(data.summary);
            renderNetWorth(data.netWorth);
            renderAccountBalances(data.accountBalances);
            renderCreditCards(data.creditCardSummaries);
            renderBillsToPay(data.billsToPay);
            renderRecentTransactions(allTransactions, newTransactionId);
            renderGoalsProgress(data.goalsProgress);
            renderBudgetProgress(data.budgetProgress);
            renderExpenseChart(data.expensesByCategory);
            renderNeedsWantsChart(data.needsWantsSummary, data.summary.totalReceitas);
            renderInvestments(data.investments); 
            renderPortfolioEvolutionChart(data.portfolioHistory);
            
            updateLastUpdateTime(selectedMonth, selectedYear);
            populateAccountsDropdown();
        }

        function onFailure(error) { hideLoading(); showError('Não foi possível carregar os dados do dashboard. Tente novamente. Se o problema persistir, contate o administrador.'); console.error('Erro ao carregar dados:', error); }
        function scrollToSection(event) { event.preventDefault(); const targetId = event.currentTarget.getAttribute('href'); const targetElement = document.querySelector(targetId); if (targetElement) { toggleMenu(false); window.scrollTo({ top: targetElement.offsetTop - 20, behavior: 'smooth' }); } }
        function updateActiveNavLink() { const sections = document.querySelectorAll('.main-content-area .card, .main-content-area .header'); const navLinks = document.querySelectorAll('.sidebar-nav a'); let currentActive = null; const scrollPosition = window.scrollY + window.innerHeight / 3; sections.forEach(section => { if (section.id) { const sectionTop = section.offsetTop; const sectionHeight = section.clientHeight; if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) { currentActive = section.id; } } }); navLinks.forEach(link => { link.classList.remove('active'); if (currentActive && link.getAttribute('href').includes(currentActive)) { link.classList.add('active'); } }); }
        function toggleMenu(forceOpen = null) { 
            const sidebar = document.getElementById('sidebar'); 
            const overlay = document.getElementById('sidebar-overlay');
            const mainContent = document.getElementById('main-content-area');
            const isOpen = sidebar.classList.contains('open'); 
            const shouldBeOpen = forceOpen === null ? !isOpen : forceOpen; 
            sidebar.classList.toggle('open', shouldBeOpen);
            overlay.classList.toggle('show', shouldBeOpen); 
            if (shouldBeOpen && window.innerWidth >= 1024) {
                mainContent.style.marginLeft = 'var(--sidebar-width)';
            } else {
                mainContent.style.marginLeft = '0';
            }
        }
        const addTransactionFab = document.getElementById('add-transaction-fab'); const transactionModal = document.getElementById('transactionModal'); const transactionModalTitle = document.getElementById('transactionModalTitle'); const closeModalBtn = document.getElementById('closeModalBtn'); const cancelFormBtn = document.getElementById('cancelFormBtn'); const transactionForm = document.getElementById('transactionForm'); const transactionIdInput = document.getElementById('transactionId'); const transactionDateInput = document.getElementById('transactionDate'); const transactionDescriptionInput = document.getElementById('transactionDescription'); const transactionTypeSelect = document.getElementById('transactionType'); const transactionValueInput = document.getElementById('transactionValue'); const transactionAccountSelect = document.getElementById('transactionAccount'); const categoryGroup = document.getElementById('category-group'); const transactionCategorySelect = document.getElementById('transactionCategory'); const subcategoryGroup = document.getElementById('subcategory-group'); const transactionSubcategorySelect = document.getElementById('transactionSubcategory'); const paymentMethodGroup = document.getElementById('payment-method-group'); const transactionPaymentMethodSelect = document.getElementById('transactionPaymentMethod'); const installmentsGroup = document.getElementById('installments-group'); const transactionInstallmentsInput = document.getElementById('transactionInstallments'); const dueDateGroup = document.getElementById('dueDate-group'); const dueDateInput = document.getElementById('dueDate');
        addTransactionFab.onclick = function() { transactionModal.classList.add('show'); transactionModalTitle.textContent = 'Adicionar Novo Lançamento'; transactionIdInput.value = ''; transactionForm.reset(); const today = new Date(); const yyyy = today.getFullYear(); const mm = String(today.getMonth() + 1).padStart(2, '0'); const dd = String(today.getDate()).padStart(2, '0'); transactionDateInput.value = `${yyyy}-${mm}-${dd}`; dueDateInput.value = `${yyyy}-${mm}-${dd}`; categoryGroup.style.display = 'none'; subcategoryGroup.style.display = 'none'; paymentMethodGroup.style.display = 'none'; installmentsGroup.style.display = 'none'; dueDateGroup.style.display = 'none'; transactionCategorySelect.innerHTML = '<option value="">Carregando categorias...</option>'; transactionSubcategorySelect.innerHTML = '<option value="">Selecione a subcategoria</option>'; transactionPaymentMethodSelect.innerHTML = '<option value="">Carregando métodos...</option>'; populateAccountsDropdown(); transactionTypeSelect.dispatchEvent(new Event('change')); }
        function openEditTransactionModal(transaction) { transactionModal.classList.add('show'); transactionModalTitle.textContent = 'Editar Lançamento'; transactionIdInput.value = transaction.id; transactionDateInput.value = transaction.data.split('/').reverse().join('-'); transactionDescriptionInput.value = transaction.descricao; transactionTypeSelect.value = transaction.tipo; transactionValueInput.value = transaction.valor; populateAccountsDropdown(); setTimeout(() => { transactionAccountSelect.value = transaction.conta; transactionTypeSelect.dispatchEvent(new Event('change')); setTimeout(() => { if (transaction.categoria) { transactionCategorySelect.value = transaction.categoria; transactionCategorySelect.dispatchEvent(new Event('change')); setTimeout(() => { if (transaction.subcategoria) { transactionSubcategorySelect.value = transaction.subcategoria; } }, 50); } if (transaction.metodoPagamento) { transactionPaymentMethodSelect.value = transaction.metodoPagamento; } }, 50); }, 50); }
        closeModalBtn.onclick = () => transactionModal.classList.remove('show'); cancelFormBtn.onclick = () => transactionModal.classList.remove('show');
        window.onclick = function(event) { if (event.target == transactionModal) transactionModal.classList.remove('show'); if (event.target == confirmDeleteModal) confirmDeleteModal.classList.remove('show'); if (event.target == categoryDetailModal) categoryDetailModal.classList.remove('show'); if (event.target == sidebarOverlay) toggleMenu(false); if (event.target == commandsGuideModal) commandsGuideModal.classList.remove('show'); if (event.target == accountModal) accountModal.classList.remove('show'); if (event.target == customizeModal) customizeModal.classList.remove('show'); }
        function populateAccountsDropdown() { transactionAccountSelect.innerHTML = '<option value="">Selecione a conta/cartão</option>'; if (allAccounts.length === 0) { transactionAccountSelect.innerHTML = '<option value="">Nenhuma conta encontrada</option>'; } else { allAccounts.forEach(account => { const option = document.createElement('option'); option.value = account.nomeOriginal; option.textContent = `${account.nomeOriginal} (${account.tipo})`; transactionAccountSelect.appendChild(option); }); } }
        transactionTypeSelect.onchange = function() { const selectedType = transactionTypeSelect.value; transactionCategorySelect.innerHTML = '<option value="">Selecione a categoria</option>'; transactionSubcategorySelect.innerHTML = '<option value="">Selecione a subcategoria</option>'; if (selectedType === 'Despesa' || selectedType === 'Receita') { categoryGroup.style.display = 'block'; subcategoryGroup.style.display = 'block'; populateCategoriesDropdown(selectedType); } else { categoryGroup.style.display = 'none'; subcategoryGroup.style.display = 'none'; } paymentMethodGroup.style.display = selectedType ? 'block' : 'none'; if(selectedType) populatePaymentMethodsDropdown(); if (selectedType === 'Transferência' || selectedType === 'Receita') { installmentsGroup.style.display = 'none'; transactionInstallmentsInput.value = 1; dueDateGroup.style.display = 'none'; dueDateInput.value = ''; } else { installmentsGroup.style.display = 'block'; } };
        function populateCategoriesDropdown(type) { transactionCategorySelect.innerHTML = '<option value="">Selecione a categoria</option>'; if (Object.keys(allCategories).length === 0) { transactionCategorySelect.innerHTML = '<option value="">Nenhuma categoria encontrada</option>'; return; } const categoriesForType = Object.keys(allCategories).filter(cat => allCategories[cat].type === type); if (categoriesForType.length === 0) { transactionCategorySelect.innerHTML = '<option value="">Nenhuma categoria para este tipo</option>'; } else { categoriesForType.forEach(categoryName => { const option = document.createElement('option'); option.value = categoryName; option.textContent = categoryName; transactionCategorySelect.appendChild(option); }); } }
        transactionCategorySelect.onchange = function() { const selectedCategory = transactionCategorySelect.value; transactionSubcategorySelect.innerHTML = '<option value="">Selecione a subcategoria</option>'; if (selectedCategory && allCategories[selectedCategory]) { subcategoryGroup.style.display = 'block'; allCategories[selectedCategory].subcategories.forEach(sub => { const option = document.createElement('option'); option.value = sub; option.textContent = sub; transactionSubcategorySelect.appendChild(option); }); } else { subcategoryGroup.style.display = 'none'; transactionSubcategorySelect.innerHTML = '<option value="">Nenhuma subcategoria</option>'; } };
        function populatePaymentMethodsDropdown() { transactionPaymentMethodSelect.innerHTML = '<option value="">Selecione o método de pagamento</option>'; if (allPaymentMethods.length === 0) { transactionPaymentMethodSelect.innerHTML = '<option value="">Nenhum método encontrado</option>'; } else { allPaymentMethods.forEach(method => { const option = document.createElement('option'); option.value = method; option.textContent = method; transactionPaymentMethodSelect.appendChild(option); }); } }
        transactionPaymentMethodSelect.onchange = function() { const selectedMethod = transactionPaymentMethodSelect.value; const selectedType = transactionTypeSelect.value; if (selectedType === 'Despesa' && selectedMethod === 'Crédito') { dueDateGroup.style.display = 'block'; } else { dueDateGroup.style.display = 'none'; dueDateInput.value = ''; } };
        transactionForm.onsubmit = function(event) { event.preventDefault(); const transactionId = transactionIdInput.value; const isEditing = !!transactionId; const transactionData = { id: transactionId || `temp-${Date.now()}`, date: transactionDateInput.value, description: transactionDescriptionInput.value, type: transactionTypeSelect.value, value: parseFloat(transactionValueInput.value), account: transactionAccountSelect.value, category: transactionCategorySelect.value, subcategory: transactionSubcategorySelect.value, paymentMethod: transactionPaymentMethodSelect.value, installments: parseInt(transactionInstallmentsInput.value) || 1, dueDate: dueDateInput.value }; const submitButton = transactionForm.querySelector('button[type="submit"]'); submitButton.disabled = true; submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...'; if (typeof google !== 'undefined' && google.script && google.script.run) { const handler = (response) => { submitButton.disabled = false; submitButton.textContent = 'Salvar Lançamento'; if (response.success) { transactionModal.classList.remove('show'); showFeedback(`Lançamento ${isEditing ? 'atualizado' : 'salvo'} com sucesso!`, 'success'); const selectedMonth = new Date(transactionData.date).getMonth(); const selectedYear = new Date(transactionData.date).getFullYear(); onSuccess(response.dashboardData, selectedMonth, selectedYear, isEditing ? transactionData.id : response.newTransactionId); } else { showFeedback(`Erro ao ${isEditing ? 'atualizar' : 'salvar'} lançamento: ` + response.message, 'error'); } }; const errorHandler = (error) => { showFeedback('Erro ao comunicar com o servidor: ' + error.message, 'error'); console.error('Erro ao salvar/atualizar lançamento:', error); submitButton.disabled = false; submitButton.textContent = 'Salvar Lançamento'; }; if (isEditing) { google.script.run .withSuccessHandler(handler) .withFailureHandler(errorHandler) .updateTransactionFromWeb(transactionData); } else { google.script.run .withSuccessHandler(handler) .withFailureHandler(errorHandler) .addTransactionFromWeb(transactionData); } } };
        const confirmDeleteModal = document.getElementById('confirmDeleteModal'); const closeDeleteModalBtn = document.getElementById('closeDeleteModalBtn'); const cancelDeleteBtn = document.getElementById('cancelDeleteBtn'); const confirmDeleteBtn = document.getElementById('confirmDeleteBtn'); let itemToDelete = null;
        closeDeleteModalBtn.onclick = () => confirmDeleteModal.classList.remove('show'); cancelDeleteBtn.onclick = () => confirmDeleteModal.classList.remove('show'); confirmDeleteBtn.onclick = () => { if (itemToDelete) { if (itemToDelete.type === 'Lançamento') { deleteTransaction(itemToDelete.id); } else if (itemToDelete.type === 'Conta') { deleteAccount(itemToDelete.id); } } };
        function confirmDeleteTransaction(transactionId, type) { itemToDelete = { id: transactionId, type: type }; document.getElementById('confirmDeleteModalTitle').textContent = `Confirmar Exclusão de ${type}`; document.getElementById('confirmDeleteModalText').textContent = `Tem certeza que deseja excluir este ${type.toLowerCase()}?`; confirmDeleteModal.classList.add('show'); }
        function deleteTransaction(transactionId) { confirmDeleteBtn.disabled = true; confirmDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Excluindo...'; if (typeof google !== 'undefined' && google.script && google.script.run) { google.script.run .withSuccessHandler(function(response) { confirmDeleteModal.classList.remove('show'); confirmDeleteBtn.disabled = false; confirmDeleteBtn.textContent = 'Excluir'; if (response.success) { showFeedback('Lançamento excluído com sucesso!', 'success'); const selectedMonth = parseInt(document.getElementById('month-select').value); const selectedYear = parseInt(document.getElementById('year-input').value); onSuccess(response.dashboardData, selectedMonth, selectedYear); } else { showFeedback('Erro ao excluir lançamento: ' + response.message, 'error'); } }) .withFailureHandler(function(error) { confirmDeleteModal.classList.remove('show'); showFeedback('Erro ao comunicar com o servidor: ' + error.message, 'error'); console.error('Erro ao excluir lançamento:', error); confirmDeleteBtn.disabled = false; confirmDeleteBtn.textContent = 'Excluir'; }) .deleteTransactionFromWeb(transactionId); } }
        const categoryDetailModal = document.getElementById('categoryDetailModal'); const closeCategoryModalBtn = document.getElementById('closeCategoryModalBtn');
        closeCategoryModalBtn.onclick = () => categoryDetailModal.classList.remove('show');
        function populateCategoryModal(transactions) { const listContainer = document.getElementById('category-transactions-list'); if (!transactions || transactions.length === 0) { listContainer.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>Nenhuma transação encontrada para esta categoria no período selecionado.</p></div>'; return; } listContainer.innerHTML = transactions.map(t => ` <div class="transaction-item"> <div class="transaction-icon ${t.tipo.toLowerCase()}"> <i class="fas fa-${t.tipo === 'Receita' ? 'arrow-up' : 'arrow-down'}"></i> </div> <div class="transaction-details"> <div class="transaction-desc">${t.descricao}</div> <div class="transaction-meta">${t.data} • ${t.conta}</div> </div> <div class="transaction-amount ${t.tipo === 'Receita' ? 'positive' : 'negative'}"> ${t.tipo === 'Receita' ? '+' : '-'}${formatCurrency(Math.abs(t.valor))} </div> </div> `).join(''); }
        const accountModal = document.getElementById('accountModal'); const addAccountBtn = document.getElementById('add-account-btn'); const closeAccountModalBtn = document.getElementById('closeAccountModalBtn'); const cancelAccountFormBtn = document.getElementById('cancelAccountFormBtn'); const accountForm = document.getElementById('accountForm'); const accountModalTitle = document.getElementById('accountModalTitle'); const originalAccountNameInput = document.getElementById('originalAccountName'); const accountNameInput = document.getElementById('accountName'); const accountTypeSelect = document.getElementById('accountType'); const accountBankInput = document.getElementById('accountBank'); const accountInitialBalanceInput = document.getElementById('accountInitialBalance');
        addAccountBtn.onclick = () => { accountModal.classList.add('show'); accountModalTitle.textContent = 'Nova Conta'; accountForm.reset(); originalAccountNameInput.value = ''; accountInitialBalanceInput.disabled = false; };
        closeAccountModalBtn.onclick = () => accountModal.classList.remove('show'); cancelAccountFormBtn.onclick = () => accountModal.classList.remove('show');
        function handleEditAccount(event) { const accountName = event.currentTarget.dataset.name; const accountData = allDashboardAccounts.find(acc => acc.nomeOriginal === accountName); if (accountData) { accountModal.classList.add('show'); accountModalTitle.textContent = 'Editar Conta'; originalAccountNameInput.value = accountData.nomeOriginal; accountNameInput.value = accountData.nomeOriginal; accountTypeSelect.value = accountData.tipo; accountBankInput.value = accountData.banco; accountInitialBalanceInput.value = accountData.saldoInicial; accountInitialBalanceInput.disabled = true; } else { showFeedback('Erro: Conta não encontrada para edição.', 'error'); } }
        function handleDeleteAccount(event) { const accountName = event.currentTarget.dataset.name; confirmDeleteTransaction(accountName, 'Conta'); }
        function deleteAccount(accountName) { confirmDeleteBtn.disabled = true; confirmDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Excluindo...'; google.script.run .withSuccessHandler(response => { confirmDeleteModal.classList.remove('show'); confirmDeleteBtn.disabled = false; confirmDeleteBtn.textContent = 'Excluir'; if (response.success) { showFeedback('Conta excluída com sucesso!', 'success'); const selectedMonth = parseInt(document.getElementById('month-select').value); const selectedYear = parseInt(document.getElementById('year-input').value); onSuccess(response.dashboardData, selectedMonth, selectedYear); } else { showFeedback('Erro ao excluir conta: ' + response.message, 'error'); } }) .withFailureHandler(error => { confirmDeleteModal.classList.remove('show'); showFeedback('Erro ao comunicar com o servidor: ' + error.message, 'error'); confirmDeleteBtn.disabled = false; confirmDeleteBtn.textContent = 'Excluir'; }) .deleteAccountFromWeb(accountName); }
        accountForm.onsubmit = (event) => { event.preventDefault(); const isEditing = !!originalAccountNameInput.value; const accountData = { originalName: originalAccountNameInput.value, name: accountNameInput.value, type: accountTypeSelect.value, bank: accountBankInput.value, initialBalance: parseFloat(accountInitialBalanceInput.value) }; const submitButton = accountForm.querySelector('button[type="submit"]'); submitButton.disabled = true; submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...'; google.script.run .withSuccessHandler(response => { submitButton.disabled = false; submitButton.textContent = 'Salvar'; if (response.success) { accountModal.classList.remove('show'); showFeedback(`Conta ${isEditing ? 'atualizada' : 'salva'} com sucesso!`, 'success'); const selectedMonth = parseInt(document.getElementById('month-select').value); const selectedYear = parseInt(document.getElementById('year-input').value); onSuccess(response.dashboardData, selectedMonth, selectedYear); } else { showFeedback(`Erro: ${response.message}`, "error"); } }) .withFailureHandler(error => { showFeedback('Erro ao comunicar com o servidor.', 'error'); submitButton.disabled = false; submitButton.textContent = 'Salvar'; }) .addOrUpdateAccountFromWeb(accountData); };
        
        const ALL_CARDS = [
            { id: 'card-receitas', title: 'Receitas do Mês' },
            { id: 'card-despesas', title: 'Despesas do Mês' },
            { id: 'card-saldo', title: 'Saldo Líquido' },
            { id: 'card-patrimonio', title: 'Patrimônio Líquido' },
            { id: 'card-contas', title: 'Minhas Contas' },
            { id: 'card-despesas-categoria', title: 'Gráfico de Despesas' },
            // --- INÍCIO DA CORREÇÃO ---
            { id: 'card-evolucao-carteira', title: 'Evolução da Carteira' },
            // --- FIM DA CORREÇÃO ---
            { id: 'card-investimentos', title: 'Carteira de Investimentos' },
            { id: 'card-orcamento', title: 'Progresso do Orçamento' },
            { id: 'card-necessidades-desejos', title: 'Gráfico Necessidades vs. Desejos' },
            { id: 'card-transacoes-recentes', title: 'Lançamentos Recentes' },
            { id: 'card-contas-a-pagar', title: 'Contas a Pagar' },
            { id: 'card-cartoes-credito', title: 'Cartões de Crédito' },
            { id: 'card-metas', title: 'Progresso das Metas' }
        ];

        const customizeBtn = document.getElementById('customize-dashboard-btn');
        const customizeModal = document.getElementById('customizeModal');
        const closeCustomizeModalBtn = document.getElementById('closeCustomizeModalBtn');
        const saveLayoutBtn = document.getElementById('saveLayoutBtn');
        const visibilityList = document.getElementById('card-visibility-list');

        function loadLayoutPreferences() {
            google.script.run
                .withSuccessHandler(applyLayout)
                .withFailureHandler(error => {
                    console.error("Erro ao buscar layout, usando padrão.", error);
                    const defaultConfig = JSON.stringify({ hiddenCards: [] });
                    applyLayout(defaultConfig);
                })
                .getDashboardLayout();
        }

        function applyLayout(layoutJSON) {
            const layoutConfig = JSON.parse(layoutJSON);
            const hiddenCards = layoutConfig.hiddenCards || [];
            ALL_CARDS.forEach(card => {
                const cardElement = document.getElementById(card.id);
                if (cardElement) {
                    cardElement.style.display = hiddenCards.includes(card.id) ? 'none' : '';
                }
            });
        }

        function saveLayoutPreferences() {
            const hiddenCards = Array.from(visibilityList.querySelectorAll('input:not(:checked)')).map(input => input.value);
            const layoutConfigJSON = JSON.stringify({ hiddenCards });
            showFeedback('A salvar personalização...', 'success');
            google.script.run
                .withSuccessHandler(response => showFeedback(response.message, response.status))
                .withFailureHandler(error => showFeedback('Erro ao salvar personalização.', 'error'))
                .saveDashboardLayout(layoutConfigJSON);
        }

        function populateVisibilityModal() {
            visibilityList.innerHTML = '';
            ALL_CARDS.forEach(card => {
                const cardElement = document.getElementById(card.id);
                const isChecked = cardElement ? cardElement.style.display !== 'none' : true;
                const listItem = document.createElement('li');
                listItem.innerHTML = `<label><input type="checkbox" value="${card.id}" ${isChecked ? 'checked' : ''}> ${card.title}</label>`;
                visibilityList.appendChild(listItem);
            });
        }
        
        customizeBtn.onclick = () => {
            populateVisibilityModal();
            customizeModal.classList.add('show');
        };

        closeCustomizeModalBtn.onclick = () => customizeModal.classList.remove('show');
        
        saveLayoutBtn.onclick = () => {
            const checkboxes = visibilityList.querySelectorAll('input');
            checkboxes.forEach(input => {
                const cardElement = document.getElementById(input.value);
                if (cardElement) {
                    cardElement.style.display = input.checked ? '' : 'none';
                }
            });
            saveLayoutPreferences();
            customizeModal.classList.remove('show');
        };

        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const showReconciliationBtn = document.getElementById('show-reconciliation-view');
        const reconciliationView = document.getElementById('reconciliation-view');
        const processStatementBtn = document.getElementById('process-statement-btn');
        const statementFileInput = document.getElementById('statement-file-input');
        const resultsContainer = document.getElementById('reconciliation-results-container');
        const resultsContent = document.getElementById('reconciliation-results');
        const reconciliationLoading = document.getElementById('reconciliation-loading');

        function onReconciliationFailure(error) {
            reconciliationLoading.style.display = 'none';
            resultsContent.innerHTML = `<div class="error-message"><strong>Falha na Conciliação:</strong> ${error.message}</div>`;
            console.error('Erro na conciliação:', error);
        }

        processStatementBtn.addEventListener('click', () => {
            const file = statementFileInput.files[0];
            if (!file) {
                showFeedback('Por favor, selecione um arquivo.', 'error');
                return;
            }

            resultsContainer.style.display = 'block';
            reconciliationLoading.style.display = 'flex';
            resultsContent.innerHTML = '';

            const reader = new FileReader();
            reader.onload = function(event) {
                const fileContent = event.target.result;
                google.script.run
                    .withSuccessHandler(displayReconciliationResults)
                    .withFailureHandler(onReconciliationFailure)
                    .processBankStatement(fileContent, file.name);
            };
            reader.onerror = function() {
                showFeedback('Erro ao ler o arquivo.', 'error');
                reconciliationLoading.style.display = 'none';
            };
            reader.readAsText(file);
        });

        function displayReconciliationResults(result) {
            try { 
                reconciliationLoading.style.display = 'none';
                console.log("Dados recebidos da conciliação:", result);

                if (!result) { 
                    resultsContent.innerHTML = `<div class="error-message">O servidor não retornou uma resposta válida. Verifique os logs do Apps Script.</div>`;
                    return;
                }
                if (result.error) {
                    resultsContent.innerHTML = `<div class="error-message">${result.error}</div>`;
                    return;
                }

                let html = '';

                if (result.notFound && result.notFound.length > 0) {
                    html += `<div class="result-section"><h4><i class="fas fa-plus-circle text-green-400"></i> Transações para Importar (${result.notFound.length})</h4><div id="import-list">`;
                    result.notFound.forEach((tx, index) => {
                        const txDate = new Date(tx.date);
                        const formattedDate = txDate.toLocaleDateString('pt-BR');
                        const isExpense = tx.type === 'Despesa';
                        html += `<div class="tx-item tx-item-import"><input type="checkbox" class="import-checkbox" checked data-index="${index}"><div class="tx-icon ${isExpense ? 'text-red-400' : 'text-green-400'}"><i class="fas fa-file-invoice-dollar"></i></div><div><div>${tx.description}</div><div class="text-sm text-muted">${formattedDate}</div></div><div class="tx-value ${isExpense ? 'negative' : 'positive'}">${formatCurrency(tx.value)}</div></div>`;
                    });
                    html += `</div><div class="form-actions" style="justify-content: flex-start; margin-top: 20px;"><button id="import-selected-btn" class="btn btn-primary">Importar Selecionadas</button></div></div>`;
                } else {
                     html += `<div class="result-section"><h4><i class="fas fa-check-circle text-green-400"></i> Nenhuma nova transação para importar!</h4><p class="text-muted" style="margin-top: 8px;">Parece que todas as transações do seu extrato já foram lançadas no sistema.</p></div>`;
                }

                if (result.reconciled && result.reconciled.length > 0) {
                     html += `<div class="result-section"><h4><i class="fas fa-check-double text-blue-400"></i> Transações Já Conciliadas (${result.reconciled.length})</h4>`;
                     result.reconciled.forEach(match => {
                        const txDate = new Date(match.imported.date);
                        const formattedDate = txDate.toLocaleDateString('pt-BR');
                        const isExpense = match.imported.type === 'Despesa';
                         html += `<div class="tx-item"><div class="tx-icon ${isExpense ? 'text-red-400' : 'text-green-400'}"><i class="fas fa-link"></i></div><div><div>${match.imported.description}</div><div class="text-sm text-muted">Extrato: ${formattedDate}</div></div><div class="tx-value ${isExpense ? 'negative' : 'positive'}">${formatCurrency(match.imported.value)}</div></div>`;
                     });
                     html += `</div>`;
                }

                resultsContent.innerHTML = html;

                if (result.notFound && result.notFound.length > 0) {
                    document.getElementById('import-selected-btn').addEventListener('click', () => {
                        const checkboxes = document.querySelectorAll('.import-checkbox:checked');
                        const transactionsToImport = [];
                        checkboxes.forEach(cb => {
                            transactionsToImport.push(result.notFound[parseInt(cb.dataset.index)]);
                        });

                        if (transactionsToImport.length === 0) {
                            showFeedback('Nenhuma transação selecionada para importar.', 'error');
                            return;
                        }
                        
                        reconciliationLoading.style.display = 'flex';
                        resultsContent.innerHTML = '';

                        google.script.run
                            .withSuccessHandler(response => {
                                reconciliationLoading.style.display = 'none';
                                resultsContainer.style.display = 'none';
                                statementFileInput.value = '';
                                showFeedback(response.message, 'success');
                                onSuccess(response.dashboardData, new Date().getMonth(), new Date().getFullYear());
                                switchView('dashboard');
                            })
                            .withFailureHandler(onReconciliationFailure)
                            .importNewTransactions(transactionsToImport);
                    });
                }
            } catch (e) {
                console.error("Erro ao renderizar resultados da conciliação:", e);
                resultsContent.innerHTML = `<div class="error-message">Ocorreu um erro inesperado ao exibir os resultados. Verifique o console do navegador (F12) para mais detalhes.</div>`;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const openCommandsBtn = document.getElementById('open-commands-guide-btn');
            const commandsModal = document.getElementById('commandsGuideModal');
            const closeCommandsBtn = document.getElementById('closeCommandsGuideBtn');
            const commandsContent = document.getElementById('commandsGuideContent');
            openCommandsBtn.addEventListener('click', () => { commandsModal.classList.add('show'); if (commandsContent.querySelector('.loading')) { google.script.run .withSuccessHandler(htmlContent => { commandsContent.innerHTML = htmlContent; }) .withFailureHandler(error => { commandsContent.innerHTML = '<div class="error-message">Não foi possível carregar o guia de comandos.</div>'; console.error("Erro ao carregar guia:", error); }) .getCommandsGuideHtml(); } });
            closeCommandsBtn.onclick = () => { commandsModal.classList.remove('show'); };
            
            const dashboardView = document.getElementById('dashboard-view');
            const agendaView = document.getElementById('agenda-view');
            const reconciliationView = document.getElementById('reconciliation-view');
            
            const showDashboardBtn = document.getElementById('show-dashboard-view');
            const showAgendaBtn = document.getElementById('show-agenda-view');
            
            function switchView(viewToShow) {
                dashboardView.style.display = 'none';
                agendaView.style.display = 'none';
                reconciliationView.style.display = 'none';

                showDashboardBtn.classList.remove('active');
                showAgendaBtn.classList.remove('active');
                showReconciliationBtn.classList.remove('active');

                if (viewToShow === 'agenda') {
                    agendaView.style.display = 'block';
                    showAgendaBtn.classList.add('active');
                    initializeCalendar();
                } else if (viewToShow === 'reconciliation') {
                    reconciliationView.style.display = 'block';
                    showReconciliationBtn.classList.add('active');
                } else {
                    dashboardView.style.display = 'block';
                    showDashboardBtn.classList.add('active');
                }
                toggleMenu(false);
            }

            showDashboardBtn.addEventListener('click', () => switchView('dashboard'));
            showAgendaBtn.addEventListener('click', () => switchView('agenda'));
            showReconciliationBtn.addEventListener('click', () => switchView('reconciliation'));
            function initializeCalendar() { if (calendarInstance) { calendarInstance.updateSize(); return; } const calendarEl = document.getElementById('calendar'); calendarInstance = new FullCalendar.Calendar(calendarEl, { initialView: 'dayGridMonth', locale: 'pt-br', height: '80vh', headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' }, events: function(fetchInfo, successCallback, failureCallback) { google.script.run .withSuccessHandler(response => { if (response.success) { successCallback(response.tasks); } else { showFeedback('Erro ao buscar tarefas: ' + response.message, 'error'); failureCallback(new Error(response.message)); } }) .withFailureHandler(error => { showFeedback('Falha ao comunicar com o servidor da agenda.', 'error'); failureCallback(error); }) .getCalendarTasks(); }, eventDidMount: function(info) { info.el.setAttribute('title', info.event.title); } }); calendarInstance.render(); }
            const today = new Date();
            document.getElementById('month-select').value = today.getMonth();
            document.getElementById('year-input').value = today.getFullYear();
            loadDashboardData();
            document.getElementById('hamburger-menu').addEventListener('click', () => toggleMenu());
            document.getElementById('sidebar-overlay').addEventListener('click', () => toggleMenu(false));
            
            loadLayoutPreferences();
        });
    </script>
</body>
</html>

