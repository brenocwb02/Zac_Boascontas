<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuração do Bot - Gasto Certo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <?!= include('Stylesheet_Dark'); ?>
    <style>
        body { padding: 0; background: transparent; }
        .container { padding: 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card" style="margin-bottom: 0; border: none; box-shadow: none;">
            <div class="card-header" style="padding-bottom: 0; margin-bottom: 10px; justify-content: center; text-align: center; flex-direction: column;">
                <h2 class="card-title" style="font-size: 1.8rem; font-weight: 800; margin-right: 0;">Assistente de Configuração</h2>
                <p style="color: var(--text-muted); margin-top: 8px;">Vamos conectar seu bot em 3 passos simples.</p>
            </div>
            <div class="card-content">
                
                <!-- PASSO 1 -->
                <div class="info-box" style="background: rgba(139, 92, 246, 0.1); border-color: var(--accent-purple); margin-top: 0;">
                    <h5 style="color: var(--accent-purple);"><i class="fas fa-rocket"></i> Passo 1: Ative o Aplicativo Web</h5>
                    <p>Clique no botão abaixo para abrir a página de ativação. Você precisará autorizar o script a funcionar na sua conta.</p>
                    <button id="openEditorButton" class="btn btn-primary" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue)); margin-top: 15px;">
                        <i class="fas fa-external-link-alt"></i> Abrir Página de Ativação
                    </button>
                </div>

                <div id="deploymentGuide" class="info-box" style="display: none; background: rgba(20, 184, 166, 0.1); border-color: var(--accent-teal);">
                    <h5 style="color: var(--accent-teal);"><i class="fas fa-info-circle"></i> Na nova aba, siga estes cliques:</h5>
                    <ol style="list-style-type: decimal; padding-left: 20px; color: var(--text-secondary);">
                        <li>Clique em <strong>"Implantar"</strong> e selecione <strong>"Nova implantação"</strong>.</li>
                        <li>Em "Quem pode acessar", escolha <strong>"Qualquer pessoa"</strong>.</li>
                        <li>Clique em <strong>"Implantar"</strong> e autorize o acesso.</li>
                        <li>Por fim, <strong>copie a "URL do app da Web"</strong>.</li>
                    </ol>
                </div>

                <!-- PASSO 2 -->
                <div class="form-group" style="margin-top: 24px;">
                    <label for="webAppUrl"><i class="fas fa-link"></i> Passo 2: Cole a URL do App da Web</label>
                    <input type="url" id="webAppUrl" placeholder="Cole a URL copiada aqui">
                </div>
                <div class="form-group">
                    <label for="token"><i class="fab fa-telegram"></i> Token do Bot do Telegram</label>
                    <input type="password" id="token" placeholder="Token do @BotFather">
                </div>
                <div class="form-group">
                    <label for="chatId"><i class="fas fa-user-secret"></i> Seu Chat ID de Administrador</label>
                    <input type="text" id="chatId" placeholder="ID do @userinfobot">
                </div>
                <!-- NOVO CAMPO ADICIONADO -->
                <div class="form-group">
                    <label for="speechApiKey"><i class="fas fa-microphone-alt"></i> Chave da API de Voz (Opcional)</label>
                    <input type="password" id="speechApiKey" placeholder="Chave da API do Google Speech-to-Text">
                </div>
                
                <!-- PASSO 3 -->
                <button id="submitButton" class="btn btn-primary" style="margin-top: 24px;">
                    <i class="fas fa-check-circle"></i> Passo 3: Salvar e Conectar
                </button>
                
                <div id="status"></div>
            </div>
        </div>
    </div>

    <script>
      document.getElementById('openEditorButton').addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Abrindo...';
        google.script.run
          .withSuccessHandler(function(url) {
            window.open(url, '_blank');
            document.getElementById('deploymentGuide').style.display = 'block';
            document.getElementById('openEditorButton').innerHTML = '<i class="fas fa-check"></i> Página Aberta';
          })
          .withFailureHandler(function(error) {
            showStatus("Não foi possível abrir o editor: " + error.message, "error");
          })
          .getScriptEditorUrl();
      });

      document.getElementById('submitButton').addEventListener('click', function() {
        const token = document.getElementById('token').value;
        const chatId = document.getElementById('chatId').value;
        const webAppUrl = document.getElementById('webAppUrl').value;
        const speechApiKey = document.getElementById('speechApiKey').value; // <-- ADICIONADO
        const submitButton = this;

        if (!webAppUrl || !token || !chatId) {
          showStatus("URL, Token e Chat ID são obrigatórios.", "error");
          return;
        }
        if (!webAppUrl.startsWith("https://script.google.com/macros/s/")) {
          showStatus("A URL do App da Web parece inválida.", "error");
          return;
        }

        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Conectando...';

        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              showStatus("Tudo certo! O bot está conectado. Esta janela fechará em 3 segundos.", "success");
              setTimeout(() => google.script.host.close(), 3000);
            } else {
              showStatus(`Erro: ${response.message}`, "error");
              submitButton.disabled = false;
              submitButton.innerHTML = '<i class="fas fa-check-circle"></i> Salvar e Conectar';
            }
          })
          .withFailureHandler(function(error) {
            showStatus(`Erro de comunicação: ${error.message}`, "error");
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-check-circle"></i> Salvar e Conectar';
          })
          // ATUALIZADO para enviar a nova chave
          .saveCredentialsAndSetupWebhook(token, chatId, webAppUrl, speechApiKey);
      });

      function showStatus(message, type) {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        statusDiv.classList.remove('success', 'error');
        if (message) {
            statusDiv.classList.add(type);
        }
      }
    </script>
</body>
</html>
